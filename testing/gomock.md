- [Introduction](#introduction)
- [Installation](#installation)
- [Usage](#usage)
- [Test Cases](#test-cases)
  - [Define Interface](#define-interface)
  - [Call Method](#call-method)
  - [Generate Mock File](#generate-mock-file)
  - [Write Test Cases](#write-test-cases)
  - [Run Test](#run-test)
- [Test Coverage](#test-coverage)
  - [Web Dashboard](#web-dashboard)
- [Other](#other)
  - [Mock Methods](#mock-methods)
  - [Generate Multiple Mock Files](#generate-multiple-mock-files)

# Introduction

åœ¨å¯¦éš›é–‹ç™¼å°ˆæ¡ˆé€²è¡Œå–®å…ƒæ¸¬è©¦çš„æ™‚å€™, å»å¾€å¾€ç™¼ç¾æœ‰ä¸€å¤§å †çš„ä¾è³´, é€™æ™‚å°±æ˜¯ `gomock` å¤§é¡¯èº«æ‰‹çš„æ™‚å€™äº†

`Gomock` ç‚º Go çš„ä¸€å€‹ mock framework, ç”±å®˜æ–¹æä¾›ä¸¦ç¶­è­·

# Installation

```go
$ go get -u github.com/golang/mock/gomock
$ go install github.com/golang/mock/mockgen
```

é¦–å…ˆéœ€è¦å®‰è£ `gomock` å’Œ mock ç¨‹å¼ç¢¼çš„ç”Ÿæˆå·¥å…· `mockgen`, å¾Œè€…å¯ä»¥å¤§å¹…ç¯€çœå·¥ä½œé‡, åªéœ€è¦ç­è§£å…¶ä½¿ç”¨æ–¹å¼å³å¯

# Usage

åœ¨ `mockgen` æŒ‡ä»¤ä¸­æ”¯æ´å…©ç¨®ç”Ÿæˆæ¨¡å¼:

- source: å¾ source code ç”Ÿæˆ mock interface (é€šé `-source` å•Ÿç”¨)

    ```go
    mockgen -source=foo.go [other options]
    ```

- reflect: é€šéä½¿ç”¨åå°„ä¾†ç”Ÿæˆ mock interface, å…¶é€šéå‚³éå…©å€‹éæ¨™èªŒåƒæ•¸å•Ÿç”¨: å°å…¥è·¯å¾‘å’Œä»¥é€—è™Ÿå€éš”çš„ interface åˆ—è¡¨

    ```go
    mockgen database/sql/driver Conn,Driver
    ```

æœ¬è³ªä¸Šä¾†èªªä¸Šè¿°å…©ç¨®æ¨¡å¼ç”Ÿæˆçš„ mock ç¨‹å¼ç¢¼ä¸¦ç„¡å€åˆ¥, é¸æ“‡åˆé©çš„ä½¿ç”¨å³å¯

# Test Cases

ä¸‹é¢æœƒç¤ºç¯„æ¨¡æ“¬ä¸€å€‹ç°¡å–®çš„ test case ä»¥ç†Ÿæ‚‰æ•´é«”çš„æ¸¬è©¦æµç¨‹

æ¸¬è©¦æ­¥é©Ÿå¦‚ä¸‹:

- æ§‹æ€æ•´é«”æ¸¬è©¦é‚è¼¯
- å®šç¾©æƒ³è¦æ¨¡æ“¬çš„ä¾è³´é …çš„ interface
- ä½¿ç”¨ `mockgen` æŒ‡ä»¤å°æ‰€éœ€ mock çš„ interface ç”Ÿæˆ mock æ–‡ä»¶
- ç·¨å¯«å–®å…ƒæ¸¬è©¦é‚è¼¯, åœ¨æ¸¬è©¦ä¸­ä½¿ç”¨ mock
- é€²è¡Œå–®å…ƒæ¸¬è©¦é©—è­‰

## Define Interface

åœ¨ `person/male.go` æª”æ¡ˆå®šç¾© `Male` interface:

```go
package person

type Male interface {
    Get(id int64) error
}
```

## Call Method

åœ¨ `user/user.go` æª”æ¡ˆä¸­èª¿ç”¨ `Male` çš„ `Get()` æ–¹æ³•:

```go
package user

type User struct {
    Person person.Male
}

func NewUser(p person.Male) *User {
    return &User{Person: p}
}

func (u *User) GetUserInfo(id int64) error {
    return u.Person.Get(id)
}
```

## Generate Mock File

å›åˆ°æ ¹ç›®éŒ„åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤:

```go
$ mockgen -source=./person/male.go -destination=./mock/male_mock.go -package=mock
```

- source: è¨­ç½®éœ€è¦ mock çš„ interface æª”æ¡ˆ
- destination: è¨­ç½® mock æª”æ¡ˆè¼¸å‡ºçš„ä½ç½®, é»˜èªè¼¸å‡º Stdout
- package: è¨­ç½® mock æ–‡ä»¶çš„ package name, é»˜èªç‚º `mock_filename(mock_person)`
- å®Œæ•´åƒæ•¸åƒè€ƒ[å®˜æ–¹æ‰‹å†Š](https://github.com/golang/mock#running-mockgen)

åŸ·è¡Œå®Œç•¢å¾Œç™¼ç¾ `mock/` ç›®éŒ„ä¸‹å¤šäº†ä¸€å€‹ `male_mock.go` çš„æª”æ¡ˆ, å³ç‚º mock æª”æ¡ˆ

è¼¸å‡ºå¾Œçš„ mock file å¦‚ä¸‹:

```go
// Code generated by MockGen. DO NOT EDIT.
// Source: ./person/male.go

// Package mock is a generated GoMock package.
package mock

import (
    gomock "github.com/golang/mock/gomock"
    reflect "reflect"
)

// MockMale is a mock of Male interface
type MockMale struct {
    ctrl     *gomock.Controller
    recorder *MockMaleMockRecorder
}

// MockMaleMockRecorder is the mock recorder for MockMale
type MockMaleMockRecorder struct {
    mock *MockMale
}

// NewMockMale creates a new mock instance
func NewMockMale(ctrl *gomock.Controller) *MockMale {
    mock := &MockMale{ctrl: ctrl}
    mock.recorder = &MockMaleMockRecorder{mock}
    return mock
}

// EXPECT returns an object that allows the caller to indicate expected use
func (m *MockMale) EXPECT() *MockMaleMockRecorder {
    return m.recorder
}

// Get mocks base method
func (m *MockMale) Get(id int64) error {
    ret := m.ctrl.Call(m, "Get", id)
    ret0, _ := ret[0].(error)
    return ret0
}

// Get indicates an expected call of Get
func (mr *MockMaleMockRecorder) Get(id interface{}) *gomock.Call {
    return mr.mock.ctrl.RecordCallWithMethodType(mr.mock, "Get", reflect.TypeOf((*MockMale)(nil).Get), id)
}
```

## Write Test Cases

åœ¨ `user/user_test.go` æª”æ¡ˆç·¨å¯« test cases:

```go
package user

func TestUser_GetUserInfo(t *testing.T) {
    ctl := gomock.NewController(t)
    defer ctl.Finish()

    var id int64 = 1
    mockMale := mock.NewMockMale(ctl)
    gomock.InOrder(
        mockMale.EXPECT().Get(id).Return(nil),
    )

    user := NewUser(mockMale)
    err := user.GetUserInfo(id)
    if err != nil {
        t.Errorf("user.GetUserInfo err: %v", err)
    }
}
```

- gomock.NewController: è¿”å› `gomock.Controller`, å…¶ä»£è¡¨ mock ç”Ÿæ…‹ç³»çµ±ä¸­çš„é ‚å±¤æ§ä»¶, å®šç¾©äº† mock ç‰©ä»¶çš„ç¯„åœ, ç”Ÿå‘½é€±æœŸå’ŒæœŸæœ›å€¼, å¦å…¶ç‚º thread-safe
- mock.NewMockMale: å‰µå»ºä¸€å€‹æ–°çš„ mock instance
- gomock.InOrder: è²æ˜çµ¦å®šçš„èª¿ç”¨æ‡‰æŒ‰é †åºé€²è¡Œ(ç‚ºå° `gomock.After` çš„äºŒæ¬¡å°è£)
- mockMale.EXPECT().Get(id).Return(nil): 
  - EXPECT(): è¿”å›ä¸€å€‹å…è¨±èª¿ç”¨è€…è¨­ç½®`æœŸæœ›å€¼`å’Œ`è¿”å›å€¼`çš„ç‰©ä»¶
  - Get(id): è¨­ç½® `input parameter` ä¸¦èª¿ç”¨ mock instance çš„æ–¹æ³•
  - Return(nil): è¨­ç½®å…ˆå‰èª¿ç”¨æ–¹æ³•çš„ `output parameter`
- NewUser(mockMale): å‰µå»º User instance, é€™è£¡æ³¨å…¥ mock ç‰©ä»¶, å› æ­¤å¯¦éš›ä¸Šåœ¨å¾Œé¢çš„ `user.GetUserInfo(id)` èª¿ç”¨ä¸­èª¿ç”¨çš„æ˜¯äº‹å…ˆæ¨¡æ“¬å¥½çš„ mock æ–¹æ³• `(input parameter id ç‚º 1)`
- ctl.Finish(): é€²è¡Œ mock instance çš„æœŸæœ›å€¼æ–·è¨€, ä¸€èˆ¬æœƒä½¿ç”¨ `defer` å»¶é²åŸ·è¡Œä»¥ç¢ºä¿åŸ·è¡Œ

## Run Test

å›åˆ°æ ¹ç›®éŒ„ä¸¦åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤:

```go
$ go test ./user
ok      github.com/regy/mockd/user
```

å³å®Œæˆå–®å…ƒæ¸¬è©¦, å¯ä»¥é€éèª¿æ•´ `Return()` è¿”å›å€¼ä¾†å¾—åˆ°ä¸ä¸€æ¨£çš„æ¸¬è©¦çµæœ

# Test Coverage

```go
$ go test -cover ./user
ok      github.com/regy/mockd/user    (cached)    coverage: 100.0% of statements
```

å¯ä»¥é€šéè¨­ç½® `-cover` åƒæ•¸ä¾†é–‹å•Ÿ coverage ratio çš„çµ±è¨ˆ

## Web Dashboard

- ç”Ÿæˆ test coverage çš„ profile æª”æ¡ˆ:
  
  ```go
  $ go test ./... -coverprofile=cover.out
  ```

- åˆ©ç”¨ profile æª”æ¡ˆç”Ÿæˆå¯è¦–åŒ–ä»‹é¢:
  
  ```go
  $ go tool cover -html=cover.out
  ```

å³å¯é€éå¯è¦–åŒ–ä»‹é¢æŸ¥çœ‹ test coverage æƒ…æ³

# Other

## Mock Methods

èª¿ç”¨æ–¹æ³•:

- Call.Do(): è²æ˜åŒ¹é…æ™‚è¦é‹è¡Œçš„æ“ä½œ
- Call.DoAndReturn(): è²æ˜åŒ¹é…æ™‚è¦é‹è¡Œçš„æ“ä½œ, ä¸”æ¨¡æ“¬è¿”å›è©²å‡½å¼çš„è¿”å›å€¼
- Call.MaxTimes(): è¨­ç½®æœ€å¤§çš„èª¿ç”¨æ¬¡æ•¸ç‚º n æ¬¡
- Call.MinTimes(): è¨­ç½®æœ€å°çš„èª¿ç”¨æ¬¡æ•¸ç‚º n æ¬¡
- Call.AnyTimes(): å…è¨±èª¿ç”¨æ¬¡æ•¸ç‚º 0 æˆ–æ›´å¤šæ¬¡
- Call.Times(): è¨­ç½®èª¿ç”¨æ¬¡æ•¸ç‚º n æ¬¡

åƒæ•¸åŒ¹é…:

- gomock.Any(): åŒ¹é…ä»»æ„å€¼
- gomock.Eq(): é€šéåå°„åŒ¹é…åˆ°æŒ‡å®šå‹åˆ¥å€¼, ç„¡éœ€æ‰‹å‹•è¨­ç½®
- gomock.Nil(): è¿”å› `nil`

>ğŸ’¡ https://godoc.org/github.com/golang/mock/gomock#pkg-index

## Generate Multiple Mock Files

å¯ä»¥åˆ©ç”¨ `go:generate` ä¾†å®Œæˆæ‰¹é‡è™•ç†åŠŸèƒ½:

```go
go generate [-run regexp] [-n] [-v] [-x] [build flags] [file.go... | packages]
```

